<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PAGE_TITLE}}</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom scrollbar for chat messages (optional) */
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1; /* Tailwind gray-200 */
            border-radius: 10px;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888; /* Tailwind gray-500 */
            border-radius: 10px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555; /* Tailwind gray-700 */
        }
        /* Basic body styling */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure full height for chat layout */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, chat area will scroll */
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }
        /* Style for thinking indicator */
        .thinking-indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            background-color: #e2e8f0; /* Tailwind gray-200 */
            color: #4a5568; /* Tailwind gray-700 */
            align-self: flex-start;
        }
        .thinking-indicator .dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #4a5568; /* Tailwind gray-700 */
            border-radius: 50%;
            display: inline-block;
            animation: an_blink 1.4s infinite both;
        }
        .thinking-indicator .dot:nth-child(1) { animation-delay: 0s; }
        .thinking-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes an_blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        /* Styling for Markdown content within chat bubbles */
        .chat-bubble-content p {
            margin-bottom: 0.5rem; /* Space between paragraphs */
        }
        .chat-bubble-content p:last-child {
            margin-bottom: 0;
        }
        .chat-bubble-content ul, .chat-bubble-content ol {
            margin-left: 1.5rem; /* Indent lists */
            margin-bottom: 0.5rem;
            list-style-position: outside; /* Ensures bullets/numbers are outside the text flow */
        }
        .chat-bubble-content ul {
            list-style-type: disc;
        }
        .chat-bubble-content ol {
            list-style-type: decimal;
        }
        .chat-bubble-content li {
            margin-bottom: 0.25rem;
        }
        .chat-bubble-content strong {
            font-weight: 600; /* Tailwind semibold */
        }
        /* Basic styling for code blocks generated by marked.js */
        .chat-bubble-content pre {
            background-color: #2d3748; /* Tailwind gray-800 */
            color: #e2e8f0; /* Tailwind gray-200 */
            padding: 1rem;
            border-radius: 0.375rem; /* Tailwind rounded-md */
            overflow-x: auto; /* Allow horizontal scrolling for long code lines */
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
            font-family: 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", monospace;
            font-size: 0.875rem; /* Tailwind text-sm */
            line-height: 1.4;
        }
        .chat-bubble-content code {
            /* Inline code styling (if not inside pre) */
            /* background-color: #edf2f7; Tailwind gray-200 */
            /* color: #c53030; Tailwind red-700 */
            /* padding: 0.125rem 0.25rem; */
            /* border-radius: 0.25rem; */
            /* font-family: 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", monospace; */
        }
        /* Ensure code inside pre doesn't get the inline styling if you enable it above */
        .chat-bubble-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        /* Styling for header description if it contains paragraphs */
        .header-description p {
            margin: 0; /* Reset paragraph margin if directly injecting HTML */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div class="chat-container max-w-2xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        <header class="bg-blue-600 text-white p-4 text-center rounded-t-lg">
            <h1 class="text-xl font-semibold">{{PAGE_TITLE}}</h1> <div class="text-sm header-description">{{HEADER_DESCRIPTION_HTML}}</div> </header>

        <div id="chatMessages" class="flex-grow p-6 space-y-4 overflow-y-auto bg-gray-50">
            <div class="flex">
                <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs md:max-w-md shadow">
                    <div class="chat-bubble-content">
                        {{INITIAL_BOT_MESSAGE_HTML}} </div>
                </div>
            </div>
            </div>

        <div id="thinkingIndicator" class="hidden p-6 pt-0">
             <div class="thinking-indicator">
                <span>Thinking</span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>


        <footer class="bg-white border-t border-gray-200 p-4 rounded-b-lg">
            <form id="chatForm" class="flex items-center space-x-3">
                <input type="text" id="questionInput" placeholder="{{INPUT_PLACEHOLDER}}" autocomplete="off" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150">
                <button type="submit" id="sendButton"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50">
                    Send
                </button>
            </form>
        </footer>
    </div>

    <script>
        // DOM Elements
        const chatForm = document.getElementById('chatForm');
        const questionInput = document.getElementById('questionInput');
        const chatMessages = document.getElementById('chatMessages');
        const sendButton = document.getElementById('sendButton');
        const thinkingIndicator = document.getElementById('thinkingIndicator');

        // --- Event Listener for Form Submission ---
        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault(); 

            const questionText = questionInput.value.trim();
            if (!questionText) {
                questionInput.focus();
                return;
            }

            questionInput.disabled = true;
            sendButton.disabled = true;
            thinkingIndicator.classList.remove('hidden');

            appendMessage(questionText, 'user');
            questionInput.value = ''; 

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: questionText }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "An unknown error occurred." }));
                    console.error('API Error:', response.status, errorData);
                    appendMessage(`Error: ${errorData.error || `Failed to get an answer (status ${response.status}). Please try again.`}`, 'bot', true);
                } else {
                    const data = await response.json();
                    appendMessage(data.answer, 'bot');
                }

            } catch (error) {
                console.error('Network or other error:', error);
                appendMessage('Sorry, I encountered a problem connecting to the server. Please check your connection and try again.', 'bot', true);
            } finally {
                questionInput.disabled = false;
                sendButton.disabled = false;
                thinkingIndicator.classList.add('hidden');
                questionInput.focus(); 
            }
        });

        // --- Helper Function to Append Messages to Chat ---
        function appendMessage(text, sender, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-3');

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('p-3', 'rounded-lg', 'shadow', 'max-w-md', 'md:max-w-lg');
            
            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('chat-bubble-content');

            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                bubbleDiv.classList.add('bg-blue-500', 'text-white');
                contentWrapper.textContent = text; 
            } else { // 'bot'
                messageDiv.classList.add('justify-start');
                if (isError) {
                    bubbleDiv.classList.add('bg-red-500', 'text-white');
                    contentWrapper.textContent = text; 
                } else {
                    bubbleDiv.classList.add('bg-indigo-500', 'text-white');
                    if (typeof marked === 'function') {
                        contentWrapper.innerHTML = marked.parse(text);
                    } else if (typeof marked !== 'undefined' && typeof marked.parse === 'function') {
                         contentWrapper.innerHTML = marked.parse(text);
                    }
                    else {
                        console.warn('marked.js is not loaded correctly. Displaying raw text.');
                        contentWrapper.textContent = text; 
                    }
                }
            }

            bubbleDiv.appendChild(contentWrapper);
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        window.onload = () => {
            questionInput.focus();
            if (typeof marked === 'undefined' || (typeof marked !== 'function' && (typeof marked === 'object' && typeof marked.parse !== 'function'))) {
                console.error("Marked.js library not loaded! Markdown rendering will not work.");
                // Don't call appendMessage here as the DOM might not be fully ready for it in a way that's visible
                // The console error is the primary feedback mechanism for this dev-time issue.
            } else {
                console.log("Marked.js loaded successfully.");
            }
        };
    </script>

</body>
</html>
