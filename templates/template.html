<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PAGE_TITLE}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom scrollbar for chat messages (optional) */
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1; /* Tailwind gray-200 */
            border-radius: 10px;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888; /* Tailwind gray-500 */
            border-radius: 10px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555; /* Tailwind gray-700 */
        }
        /* Basic body styling */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure full height for chat layout */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, chat area will scroll */
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }
        /* Style for thinking indicator */
        .thinking-indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            background-color: #e2e8f0; /* Tailwind gray-200 */
            color: #4a5568; /* Tailwind gray-700 */
            align-self: flex-start; /* Align to the left like bot messages */
        }
        .thinking-indicator .dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #4a5568; /* Tailwind gray-700 */
            border-radius: 50%;
            display: inline-block;
            animation: an_blink 1.4s infinite both;
        }
        .thinking-indicator .dot:nth-child(1) { animation-delay: 0s; }
        .thinking-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes an_blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        /* Styling for Markdown content within chat bubbles */
        .chat-bubble-content p {
            margin-bottom: 0.5rem; /* Space between paragraphs */
        }
        .chat-bubble-content p:last-child {
            margin-bottom: 0;
        }
        .chat-bubble-content ul, .chat-bubble-content ol {
            margin-left: 1.5rem; /* Indent lists */
            margin-bottom: 0.5rem;
            list-style-position: outside; /* Ensures bullets/numbers are outside the text flow */
        }
        .chat-bubble-content ul {
            list-style-type: disc;
        }
        .chat-bubble-content ol {
            list-style-type: decimal;
        }
        .chat-bubble-content li {
            margin-bottom: 0.25rem;
        }
        .chat-bubble-content strong {
            font-weight: 600; /* Tailwind semibold */
        }
        /* Basic styling for code blocks generated by marked.js */
        .chat-bubble-content pre {
            background-color: #2d3748; /* Tailwind gray-800 */
            color: #e2e8f0; /* Tailwind gray-200 */
            padding: 1rem;
            border-radius: 0.375rem; /* Tailwind rounded-md */
            overflow-x: auto; /* Allow horizontal scrolling for long code lines */
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
            font-family: 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", monospace;
            font-size: 0.875rem; /* Tailwind text-sm */
            line-height: 1.4;
        }
        .chat-bubble-content code {
            /* Inline code styling (if not inside pre) */
        }
        .chat-bubble-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        .chat-bubble-content a {
    color: #F3F4F6; /* Tailwind gray-100 for light text on dark bubbles */
    text-decoration: underline;
    font-weight: 500; /* Medium weight to make it stand out a bit */
}

.chat-bubble-content a:hover {
    color: #D1D5DB; /* Tailwind gray-300 for a slightly lighter hover state */
    text-decoration: underline;
}

/* If you have user messages with a light background and dark text: */
.flex.justify-end .chat-bubble-content a { /* Targeting user message specifically if its style differs */
    color: #EBF8FF; /* A light blue, assuming user bubble is dark blue */
    /* Or, if user bubble is light and text is dark: */
    /* color: #2563EB; */ /* Tailwind blue-600 for dark text on light bubbles */
}

.flex.justify-end .chat-bubble-content a:hover {
    /* color: #BEE3F8; */ /* Lighter blue for hover */
    /* Or, if user bubble is light and text is dark: */
    /* color: #1D4ED8; */ /* Tailwind blue-700 for hover */
}
        .header-description p {
            margin: 0;
        }
        .code-block-wrapper {
            position: relative;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1e293b; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-200 */
            padding: 0.5rem 1rem;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem; /* Tailwind text-xs */
        }
        .code-language {
            font-weight: 600;
            text-transform: uppercase;
        }
        .copy-button {
            background-color: #4b5563; /* Tailwind gray-700 */
            color: #e2e8f0; /* Tailwind gray-200 */
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-button:hover {
            background-color: #6b7280; /* Tailwind gray-500 */
        }
        .copy-button.copied {
            background-color: #10b981; /* Tailwind green-500 */
        }
        .code-block-wrapper pre {
            margin-top: 0;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div class="chat-container max-w-2xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        <header class="bg-blue-600 text-white p-4 text-center rounded-t-lg">
            <h1 class="text-xl font-semibold">{{PAGE_TITLE}}</h1>
            <div class="text-sm header-description">{{HEADER_DESCRIPTION_HTML}}</div>
        </header>

        <div id="chatMessages" class="flex-grow p-6 space-y-4 overflow-y-auto bg-gray-50">
            <div class="flex">
                <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs md:max-w-md shadow">
                    <div class="chat-bubble-content" id="initialBotMessageContent">
                        </div>
                </div>
            </div>
        </div>

        <div id="thinkingIndicatorWrapper" class="hidden p-6 pt-0"> <div class="thinking-indicator"> <span>Thinking</span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>

        <footer class="bg-white border-t border-gray-200 p-4 rounded-b-lg">
            <form id="chatForm" class="flex items-center space-x-3">
                <input type="text" id="questionInput" placeholder="{{INPUT_PLACEHOLDER}}" autocomplete="off" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150">
                <button type="submit" id="sendButton"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50">
                    Send
                </button>
            </form>
            <!-- Support Link -->
            <div class="mt-3 text-center">
                <p class="text-sm text-gray-600">
                    Need personalized help? 
                    <a href="{{SUPPORT_URL}}" target="_blank" rel="noopener noreferrer" 
                       class="text-blue-600 hover:text-blue-800 underline font-medium">
                        Submit a support ticket
                    </a>
                </p>
            </div>
        </footer>
    </div>

    <script>
        // Configure marked.js renderer
        if (typeof marked !== 'undefined') {
            const renderer = new marked.Renderer();
            renderer.code = function(code, language) {
                // Handle case where code might be a token object
                let codeText = code;
                if (typeof code === 'object' && code !== null) {
                    codeText = code.text || code.raw || String(code);
                }
                
                const langClass = language ? ` class="language-${language}"` : '';
                const langDisplay = language || 'code';
                // Fix: Ensure code is a string and handle null/undefined values
                const safeCode = String(codeText || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                return `<div class="code-block-wrapper">
                    <div class="code-header">
                        <span class="code-language">${langDisplay}</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code${langClass}>${safeCode}</code></pre>
                </div>`;
            };
            marked.setOptions({
                renderer: renderer,
                highlight: function(code, lang) {
                    return code; // No client-side syntax highlighting, relying on <pre> and CSS
                }
            });
        }

        // DOM Elements
        const chatForm = document.getElementById('chatForm');
        const questionInput = document.getElementById('questionInput');
        const chatMessages = document.getElementById('chatMessages');
        const sendButton = document.getElementById('sendButton');
        const thinkingIndicatorWrapper = document.getElementById('thinkingIndicatorWrapper'); // Get the wrapper
        const initialBotMessageContent = document.getElementById('initialBotMessageContent');

        // --- Chat History ---
        let conversationHistory = []; // Format: [{ role: "user" / "assistant", content: "message text" }, ...]

        // --- Function to Add Initial Bot Message and Store in History ---
        function initializeBotMessage() {
            const initialMessageText = "{{INITIAL_BOT_MESSAGE_HTML}}"; // Get text from Flask
            initialBotMessageContent.innerHTML = typeof marked !== 'undefined' ? marked.parse(initialMessageText) : initialMessageText;
            conversationHistory.push({ role: "assistant", content: initialMessageText });
        }


        // --- Event Listener for Form Submission ---
        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const questionText = questionInput.value.trim();
            if (!questionText) {
                questionInput.focus();
                return;
            }

            // Disable input and show thinking indicator
            questionInput.disabled = true;
            sendButton.disabled = true;
            thinkingIndicatorWrapper.classList.remove('hidden'); // Show thinking indicator

            appendMessage(questionText, 'user'); // Adds to UI and conversationHistory
            questionInput.value = '';

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // Send the current question AND the history
                    body: JSON.stringify({
                        question: questionText,
                        history: conversationHistory.slice(0, -1) // Send history up to the last user message
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "An unknown error occurred." }));
                    console.error('API Error:', response.status, errorData);
                    appendMessage(`Error: ${errorData.error || `Failed to get an answer (status ${response.status}). Please try again.`}`, 'bot', true);
                } else {
                    const data = await response.json();
                    appendMessage(data.answer, 'bot'); // Adds to UI and conversationHistory
                }

            } catch (error) {
                console.error('Network or other error:', error);
                appendMessage('Sorry, I encountered a problem connecting to the server. Please check your connection and try again.', 'bot', true);
            } finally {
                // Re-enable input and hide thinking indicator
                questionInput.disabled = false;
                sendButton.disabled = false;
                thinkingIndicatorWrapper.classList.add('hidden'); // Hide thinking indicator
                questionInput.focus();
            }
        });

        // --- Helper Function to Append Messages to Chat UI and History ---
        function appendMessage(text, sender, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-3'); // Tailwind classes for layout

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('p-3', 'rounded-lg', 'shadow', 'max-w-md', 'md:max-w-lg'); // Bubble styling

            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('chat-bubble-content'); // For Markdown styling

            if (sender === 'user') {
                messageDiv.classList.add('justify-end'); // Align user messages to the right
                bubbleDiv.classList.add('bg-blue-500', 'text-white');
                contentWrapper.textContent = text; // User messages are plain text
            } else { // 'bot'
                messageDiv.classList.add('justify-start'); // Align bot messages to the left
                if (isError) {
                    bubbleDiv.classList.add('bg-red-500', 'text-white'); // Error styling
                    contentWrapper.textContent = text;
                } else {
                    bubbleDiv.classList.add('bg-indigo-500', 'text-white'); // Regular bot message styling
                    // Use marked.js to parse Markdown if available
                    if (typeof marked === 'function' || (typeof marked !== 'undefined' && typeof marked.parse === 'function')) {
                        contentWrapper.innerHTML = marked.parse(text);
                    } else {
                        console.warn('marked.js is not loaded correctly. Displaying raw text.');
                        contentWrapper.textContent = text; // Fallback to plain text
                    }

                    // Add copy buttons to code blocks after rendering
                    setTimeout(() => { // setTimeout to ensure DOM is updated
                        const copyButtons = contentWrapper.querySelectorAll('.copy-button');
                        copyButtons.forEach(button => {
                            if (!button.hasAttribute('data-listener-attached')) { // Prevent multiple listeners
                                button.setAttribute('data-listener-attached', 'true');
                                button.addEventListener('click', function() {
                                    copyCode(this);
                                });
                            }
                        });
                    }, 0);
                }
            }

            bubbleDiv.appendChild(contentWrapper);
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);

            // Add to conversation history
            // Standardize role names to "user" and "assistant" for easier processing on the backend
            conversationHistory.push({ role: (sender === 'user' ? 'user' : 'assistant'), content: text });

            // Scroll to the bottom of the chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- Function to Copy Code to Clipboard ---
        function copyCode(button) {
            const codeBlockWrapper = button.closest('.code-block-wrapper');
            if (!codeBlockWrapper) return;
            const codeElement = codeBlockWrapper.querySelector('code');
            if (!codeElement) return;

            const textToCopy = codeElement.textContent;

            // Use a temporary textarea to copy, as navigator.clipboard might be restricted in some iframe contexts
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copied!';
                button.classList.add('copied');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                button.textContent = 'Error!';
                // Fallback or message to user if execCommand fails
                // For example, prompt them to copy manually
                // alert("Failed to copy. Please select and copy manually.");
            }
            document.body.removeChild(textArea);


            // Reset button text after a delay
            setTimeout(() => {
                button.textContent = 'Copy';
                button.classList.remove('copied');
            }, 2000);
        }

        // --- Window Load ---
        window.onload = () => {
            initializeBotMessage(); // Add initial bot message to UI and history
            questionInput.focus(); // Focus on the input field

            if (typeof marked === 'undefined' || (typeof marked !== 'function' && (typeof marked === 'object' && typeof marked.parse !== 'function'))) {
                console.error("Marked.js library not loaded! Markdown rendering will not work.");
            } else {
                console.log("Marked.js loaded successfully.");
            }

            // Attach listeners to any pre-existing copy buttons (e.g., if initial message had code)
            document.querySelectorAll('.copy-button').forEach(button => {
                 if (!button.hasAttribute('data-listener-attached')) {
                    button.setAttribute('data-listener-attached', 'true');
                    button.addEventListener('click', function() {
                        copyCode(this);
                    });
                }
            });
        };
    </script>

</body>
</html>